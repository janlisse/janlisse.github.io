
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Stream Processing of Large CSV Files - 12{programmers}</title>
  <meta name="author" content="Jan Liße">

  
  <meta name="description" content="Every now and then every backend developer faces the situation to integrate/process third party data
into the companies system, provided in the form &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://janlisse.github.io/blog/2015/12/21/stream-processing-of-large-csv-files">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="" rel="alternate" title="12{programmers}" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=Fjalla+One" rel="stylesheet" type="text/css">
<!--- MathJax Configuration -->
<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-57038023-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">12{programmers}</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="https://github.com/janlisse" rel="subscribe-github" title="@janlisse on GitHub"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="20" height="20" viewbox="0 0 100 100"><path class="social" d="M 50,0 C 22.385714,0 0,22.385714 0,50 0,77.614286 22.385714,100 50,100 77.614286,100 100,77.614286 100,50 100,22.385714 77.614286,0 50,0 z m 29.692858,79.692858 c -3.859184,3.859182 -8.351022,6.887754 -13.35,9.00306 -1.27041,0.536736 -2.560204,1.009184 -3.867348,1.415306 v -7.493878 c 0,-3.938774 -1.35102,-6.835714 -4.053062,-8.690816 1.692858,-0.163264 3.24694,-0.390816 4.663266,-0.683672 1.416326,-0.292858 2.913266,-0.716328 4.491838,-1.27041 1.57857,-0.55408 2.994896,-1.213264 4.247958,-1.97755 1.253062,-0.765306 2.458164,-1.758164 3.613266,-2.978572 1.155102,-1.220408 2.12449,-2.604082 2.905102,-4.15 0.780612,-1.545918 1.4,-3.40204 1.855102,-5.566326 0.455102,-2.164286 0.683674,-4.54898 0.683674,-7.153062 0,-5.045918 -1.643878,-9.341836 -4.931634,-12.890816 C 77.44796,33.35 77.285714,29.10204 75.463266,24.512244 l -1.22143,-0.145918 c -0.845918,-0.09796 -2.368366,0.260204 -4.565306,1.07449 -2.196938,0.814286 -4.663264,2.14796 -7.396938,4.004082 -3.87449,-1.07449 -7.893878,-1.611224 -12.061224,-1.611224 -4.19898,0 -8.203062,0.536734 -12.012246,1.611224 -1.72449,-1.17245 -3.361224,-2.139796 -4.907142,-2.905102 C 31.753062,25.77449 30.516326,25.254082 29.587756,24.97653 28.660204,24.7 27.79796,24.528572 27,24.463266 c -0.79796,-0.0653 -1.310204,-0.08062 -1.537756,-0.04898 -0.22755,0.03164 -0.390816,0.0653 -0.487754,0.09796 -1.82347,4.62245 -1.985714,8.87143 -0.487756,12.743878 -3.287754,3.54796 -4.931632,7.844898 -4.931632,12.890816 0,2.604082 0.227552,4.988776 0.683674,7.153062 0.456122,2.164286 1.07449,4.020408 1.855102,5.566326 0.780612,1.545918 1.75,2.929592 2.905102,4.15 1.155102,1.220408 2.360204,2.213266 3.613264,2.978572 1.253062,0.766326 2.669388,1.42449 4.24796,1.97755 1.578572,0.554082 3.07551,0.976532 4.491836,1.27041 1.416328,0.292856 2.970408,0.521428 4.663266,0.683672 -2.669388,1.82347 -4.004082,4.720408 -4.004082,8.690816 v 7.639796 C 36.536734,89.818368 35.083674,89.3 33.656122,88.695918 c -4.99898,-2.115306 -9.490816,-5.143878 -13.35,-9.00306 -3.859184,-3.859184 -6.887754,-8.351022 -9.00306,-13.35 C 9.1163263,61.171428 8.0071428,55.67347 8.0071428,50 c 0,-5.67347 1.1091835,-11.171428 3.2969392,-16.342858 2.115306,-4.998978 5.143878,-9.490816 9.00306,-13.35 3.859184,-3.859182 8.351022,-6.887754 13.35,-9.00306 C 38.828572,9.1163266 44.32653,8.0071428 50,8.0071428 c 5.67347,0 11.171428,1.1091838 16.342858,3.2969392 5,2.115306 9.490816,5.143878 13.35,9.00306 3.859182,3.859184 6.887754,8.351022 9.00306,13.35 2.186736,5.17245 3.295918,10.67041 3.295918,16.342858 0,5.672448 -1.109182,11.171428 -3.296938,16.342858 -2.115306,4.998978 -5.143878,9.490816 -9.00204,13.35 l 0,0 z"></path></svg></a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      
        <h1 class="entry-title">Stream Processing of Large CSV Files</h1>
      
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-12-21T15:42:08+01:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>21</span><span class='date-suffix'>st</span>, <span class='date-year'>2015</span></span> <span class='time'>3:42 pm</span></time>
        
        
      </p>
    
  </header>


<div class="entry-content"><p>Every now and then every backend developer faces the situation to integrate/process third party data
into the companies system, provided in the form of plain old CSV files.
But what if the CSV file is to huge to fit into memory entirely, but you still want to leverage
parallel computing to get things done in finite time?
Once again the excellent <a href="http://doc.akka.io/docs/akka-stream-and-http-experimental/1.0/">Akka Streams</a> framework comes to the rescue.</p>

<p>Processing big csv files with Akka Streams is quite straightforward. First you need a Akka Streams <a href="http://doc.akka.io/api/akka-stream-and-http-experimental/current/#akka.stream.scaladsl.Source">Source</a>
that emits <a href="http://doc.akka.io/api/akka/current/#akka.util.ByteString">ByteStrings</a> from a local file or another storage location like S3. Then you can leverage Akka Streams classes to group the ByteStrings to lines. Afterwards
 you can then feed those lines into a CSV Parser and emit the parsed fields. Finally you can add your own processing logic i.e. mapping to a custom
 model and sending to an API or Backend Service.</p>

<p> With SynchronousFileSource Akka Streams already provides the ability to stream ByteStrings from a local file.
 Grouping them to lines is as simple as:</p>

<pre><code class="` Scala">
 private def toLine(implicit format: CSVFormat) = Framing.delimiter(
     ByteString(format.lineTerminator),
     maximumFrameLength = 4096,
     allowTruncation = true
   )
</code></pre>

<p> The CSVFormat that is passed implicitly determines delimiters, line separators etc. It must match the one that is used in the CSV data to be parsed.
 The default format uses &ldquo;,&rdquo; as delimiter and &ldquo;\r\n&rdquo; as line separator.</p>

<p> For the CSV parsing part we have written a custom Akka Streams <a href="http://doc.akka.io/docs/akka-stream-and-http-experimental/current/scala/stream-customize.html">PullPushStage</a> that transforms a raw line into a Map[String, String] with the keys being
 field names from the CSV header line. Thus this stage requires a header line to exist in the CSV. The resulting Map is emitted together
 with the current line number in the file.</p>

<p> Our implementation utilizes an existing <a href="https://github.com/tototoshi/scala-csv">Scala CSV parsing</a> lib.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='Scala'><span class='line'><span class="k">class</span> <span class="nc">CsvStage</span><span class="o">()(</span><span class="k">implicit</span> <span class="n">format</span><span class="k">:</span> <span class="kt">CSVFormat</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">PushPullStage</span><span class="o">[</span><span class="kt">String</span>, <span class="o">(</span><span class="kt">Int</span>, <span class="kt">Map</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">String</span><span class="o">])]</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">private</span> <span class="k">val</span> <span class="n">parser</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">CSVParser</span><span class="o">(</span><span class="n">format</span><span class="o">)</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">var</span> <span class="n">headers</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">]]</span> <span class="k">=</span> <span class="nc">None</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">var</span> <span class="n">line</span> <span class="k">=</span> <span class="mi">0</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">override</span> <span class="k">def</span> <span class="n">onPush</span><span class="o">(</span><span class="n">elem</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">ctx</span><span class="k">:</span> <span class="kt">Context</span><span class="o">[(</span><span class="kt">Int</span>, <span class="kt">Map</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">String</span><span class="o">])])</span><span class="k">:</span> <span class="kt">SyncDirective</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">parsed</span> <span class="k">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parseLine</span><span class="o">(</span><span class="n">elem</span><span class="o">)</span>
</span><span class='line'>    <span class="n">line</span> <span class="k">=</span> <span class="n">line</span> <span class="o">+</span> <span class="mi">1</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">headers</span><span class="o">.</span><span class="n">isEmpty</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">headers</span> <span class="k">=</span> <span class="n">parsed</span>
</span><span class='line'>      <span class="n">ctx</span><span class="o">.</span><span class="n">pull</span><span class="o">()</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">parsed</span><span class="o">.</span><span class="n">isEmpty</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">ctx</span><span class="o">.</span><span class="n">pull</span><span class="o">()</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">val</span> <span class="n">l</span> <span class="k">=</span> <span class="n">line</span> <span class="o">-&gt;</span> <span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">zip</span><span class="o">(</span><span class="n">parsed</span><span class="o">.</span><span class="n">get</span><span class="o">).</span><span class="n">toMap</span>
</span><span class='line'>      <span class="n">ctx</span><span class="o">.</span><span class="n">push</span><span class="o">(</span><span class="n">l</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">override</span> <span class="k">def</span> <span class="n">onPull</span><span class="o">(</span><span class="n">ctx</span><span class="k">:</span> <span class="kt">Context</span><span class="o">[(</span><span class="kt">Int</span>, <span class="kt">Map</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">String</span><span class="o">])])</span><span class="k">:</span> <span class="kt">SyncDirective</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">pull</span><span class="o">()</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that PushPullStage access is guaranteed to be thread-safe, similar to how you would encapsulate state within an Akka Actor.
Thus you can safely use mutable state within your implementation. Inside our implementation there is no magic.
We expect the first line to be the header line, store this and do not push it further down the stream. Beginning with the second
line we zip the headers together with the parsed fields from the CSV parser and emit it with the current line number.</p>

<p>Finally an example how to kickoff the processing:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='Scala'><span class='line'><span class="nc">SynchronousFileSource</span><span class="o">(</span><span class="n">csvFile</span><span class="o">).</span><span class="n">via</span><span class="o">(</span><span class="nc">FlowBuilder</span><span class="o">.</span><span class="n">csvFlow</span><span class="o">).</span>
</span><span class='line'>    <span class="n">runWith</span><span class="o">(</span><span class="nc">Sink</span><span class="o">.</span><span class="n">foreach</span><span class="o">(</span><span class="n">println</span><span class="o">)).</span><span class="n">onComplete</span><span class="o">(</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="n">system</span><span class="o">.</span><span class="n">shutdown</span><span class="o">())</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can find all the code <a href="https://github.com/janlisse/csv-flow">here</a> on github.</p>
</div>


  <footer>
    <p class="meta">
      
  



  <span class="byline author vcard">Authored by <span class="fn">
  
    Jan Liße
  
  </span></span>


      




<time class='entry-date' datetime='2015-12-21T15:42:08+01:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>21</span><span class='date-suffix'>st</span>, <span class='date-year'>2015</span></span> <span class='time'>3:42 pm</span></time>
      
      

<span class="categories">
  
    <a class='category' href='/blog/categories/akka-streams/'>akka streams</a>, <a class='category' href='/blog/categories/scala/'>scala</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://janlisse.github.io/blog/2015/12/21/stream-processing-of-large-csv-files/" data-via="" data-counturl="http://janlisse.github.io/blog/2015/12/21/stream-processing-of-large-csv-files/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2010/01/27/limitations-in-jsse-tls-implementation/" title="Previous Post: Limitations in JSSE TLS implementation">&laquo; Limitations in JSSE TLS implementation</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>


</div>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Jan Liße -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a> | Themed with <a href="https://github.com/lucaslew/whitespace">Whitespace</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = '12programmers';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://janlisse.github.io/blog/2015/12/21/stream-processing-of-large-csv-files/';
        var disqus_url = 'http://janlisse.github.io/blog/2015/12/21/stream-processing-of-large-csv-files/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>










  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
